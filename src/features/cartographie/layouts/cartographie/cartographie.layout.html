<div *ngIf="loadingState$ | async" class="position-absolute top-0 w-100 h-100 bg-light z-index-over-all">
  <div class="container h-100">
    <div class="row justify-content-center h-100">
      <div class="col-lg-6 m-auto">
        <div class="card border-0 shadow m-auto">
          <div class="card-body p-5">
            <div class="d-flex flex-column text-center">
              <ng-container *ngIf="fromOrientation; else: welcome">
                <p class="text-muted">Patientez quelques instants</p>
                <h3 class="card-title text-primary">
                  Nous recherchons les lieux
                  <br />
                  correspondant à votre recherche
                </h3>
              </ng-container>
              <ng-template #welcome>
                <div class="fw-bold">
                  <div class="text-muted mb-2">Patientez quelques instants</div>
                  <div class="text-primary fs-4">Nous chargeons les lieux correspondants</div>
                </div>
              </ng-template>
            </div>
            <app-cartographie-loader></app-cartographie-loader>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="d-flex h-100 flex-column">
  <nav
    [ngClass]="(loadingState$ | async) ? 'z-index-over-base' : 'z-index-over-all'"
    class="navbar navbar-expand-lg bg-light shadow-sm sticky-top py-0 d-print-none"
    aria-label="cartographie">
    <div class="container-fluid mx-3">
      <div class="navbar-collapse">
        <app-user-location
          class="me-3"
          [adresse]="(defaultAddress$ | async) ?? ''"
          (location)="resetBreadcrumbOnGeolocate($event)"></app-user-location>
        <app-location-breadcrumb
          [url]="(routerOutlet?.activatedRoute?.url | async) ?? []"
          [zoom]="(markersPresenter.zoom$ | async) ?? 0"
          (showLieux)="$event ? onShowLieuxInZone($event) : markersPresenter.reset()"></app-location-breadcrumb>
        <button
          class="navbar-btn ms-auto"
          [attr.aria-controls]="affinerRechercheOffcanvas.id"
          [class.active]="affinerRechercheOffcanvas.expanded$ | async"
          (click)="affinerRechercheOffcanvas.toggle(); aideOffcanvas.close()">
          <i
            class="me-1"
            [ngClass]="(affinerRechercheOffcanvas.expanded$ | async) ? 'ri-close-line' : 'ri-sound-module-line'"
            aria-hidden="true"></i>
          Affiner ma recherche
        </button>
        <button
          class="navbar-btn pb-1 pt-0"
          [attr.aria-controls]="aideOffcanvas.id"
          [class.active]="aideOffcanvas.expanded$ | async"
          (click)="aideOffcanvas.toggle(); affinerRechercheOffcanvas.close()">
          <i
            class="ri-2x"
            [ngClass]="(aideOffcanvas.expanded$ | async) ? 'ri-close-circle-line text-primary' : 'ri-question-line'"></i>
          <span class="visually-hidden">À propos</span>
        </button>
      </div>
    </div>
  </nav>
  <div class="d-flex flex-grow-1 overflow-hidden">
    <main
      class="border-end col-12 show-map"
      [class.show-map-for-small-devices]="showMapForSmallDevices$ | async"
      [ngClass]="router.url.includes('/details') ? 'map-details' : 'map-list'">
      <router-outlet></router-outlet>
    </main>
    <aside
      aria-label="carte interactive des lieux d'inclusion numérique"
      class="col-lg col-12 position-relative d-flex flex-column show-map"
      [class.show-map-for-small-devices]="showMapForSmallDevices$ | async">
      <mgl-map
        aria-hidden="true"
        [movingMethod]="'flyTo'"
        [movingOptions]="{speed: 2}"
        *ngIf="(markersPresenter.localisation$ | async) as localisation"
        class="h-100 w-100 overflow-hidden"
        [style]="assetsConfiguration.path + '/data/map-style.json'"
        [zoom]="[(markersPresenter.zoom$ | async) ?? 0]"
        [center]="[localisation.longitude, localisation.latitude]"
        (zoomEvt)="zooming($event)"
        (zoomEnd)="onMapViewUpdated($event)"
        (mapDragEnd)="onMapViewUpdated($event)">
        <mgl-marker *ngIf="userLocalisation" [lngLat]="[userLocalisation.longitude, userLocalisation.latitude]">
          <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
            <circle cx="14" cy="14" r="14" fill-opacity=".3" />
            <circle class="user-marker" cx="14" cy="14" r="9" fill-opacity=".65" />
          </svg>
        </mgl-marker>
        <app-territoire-markers
          *ngIf="((currentZoom$ | async) ?? 0) <= 4"
          [territoires]="(france$ | async) ?? []"
          (showLieux)="onShowLieuxInZone($event)"></app-territoire-markers>
        <app-territoire-markers
          *ngIf="((currentZoom$ | async) ?? 0) <= 7 && ((currentZoom$ | async) ?? 0) > 4"
          [territoires]="(regions$ | async) ?? []"
          [hoverId]="(markersPresenter.highlighted$ | async) ?? ''"
          (highlight)="onHighlight($event?.code)"
          (showLieux)="onShowLieuxInRegion($event)"></app-territoire-markers>
        <app-territoire-markers
          *ngIf="((currentZoom$ | async) ?? 0) < departementZoomForDistance() && ((currentZoom$ | async) ?? 0) > 7"
          [territoires]="(departements$ | async) ?? []"
          [hoverId]="(markersPresenter.highlighted$ | async) ?? ''"
          (highlight)="onHighlight($event?.code)"
          (showLieux)="onShowLieuxInDepartement($event)"></app-territoire-markers>
        <app-lieu-mediation-numerique-markers
          *ngIf="((currentZoom$ | async) ?? 0) >= 8"
          [lieuxMediationNumeriques]="(lieuxMediationNumerique$ | async) ?? []"
          [selectedId]="(markersPresenter.selected$ | async) ?? ''"
          [hoverId]="(markersPresenter.highlighted$ | async) ?? ''"
          (highlight)="onHighlight($event?.id)"
          (showDetails)="onShowDetails($event)"></app-lieu-mediation-numerique-markers>
      </mgl-map>
      <div class="p-3 d-flex d-lg-none bg-primary align-items-center">
        <button class="btn btn-link link-light text-decoration-none" (click)="toggleMapForSmallDevices()">
          <i class="ri-arrow-left-s-line" aria-hidden="true"></i>
          Afficher la liste
        </button>
        <i class="ms-auto small text-white" *ngIf="(resultsCount$ | async) as resultCount" [ngPlural]="resultCount">
          <ng-template ngPluralCase="=0">Aucun résultat</ng-template>
          <ng-template ngPluralCase="=1">1 résultat</ng-template>
          <ng-template ngPluralCase="other">{{ resultCount }} résultats</ng-template>
        </i>
      </div>
      <app-offcanvas
        #affinerRechercheOffcanvas
        class="z-index-over-all"
        heading="Options pour affiner la recherche"
        [isAbsolute]="true"
        [useContainer]="false"
        [useHeader]="false">
        <div class="d-flex flex-column h-100 border-top">
          <div class="flex-grow-1">
            <app-affiner-recherche-form
              *ngIf="affinerRechercheOffcanvas.expanded$ | async"
              [lieuxMediationNumeriques]="(allLieuxMediationNumerique$ | async) ?? []"></app-affiner-recherche-form>
          </div>
          <div class="mt-auto bg-white p-3 text-center">
            <app-modifier-orientation></app-modifier-orientation>
            <button class="btn btn-primary" (click)="affinerRechercheOffcanvas.toggle()">Terminer</button>
          </div>
        </div>
      </app-offcanvas>
      <app-offcanvas
        #aideOffcanvas
        class="z-index-over-all"
        heading="À propos"
        [isAbsolute]="true"
        [useContainer]="false"
        [useHeader]="false">
        <div class="d-flex flex-column h-100 bg-white border-top">
          <div class="list-group list-group-flush">
            <a
              href="https://labase.anct.gouv.fr/ressource/995"
              target="_blank"
              rel="noopener noreferrer"
              class="list-group-item list-group-item-action fw-bold py-4">
              FAQ
            </a>
            <a
              href="https://labase.anct.gouv.fr/ressource/974"
              target="_blank"
              rel="noopener noreferrer"
              class="list-group-item list-group-item-action fw-bold py-4">
              Comment orienter ?
            </a>
          </div>
          <div class="mt-auto bg-light p-4">
            <a
              class="btn orientation-btn bg-white mb-3 p-3 rounded-0 d-flex d-flex align-items-center"
              href="https://labase.anct.gouv.fr/base/356?tags=&page=0&tab=resources"
              target="_blank"
              rel="noopener noreferrer">
              <span class="ri-circled bg-primary text-light fw-normal me-3" aria-hidden="true"><i class="ri-link"></i></span>
              <span class="orientation-btn-label my-auto text-start lh-sm">
                La Cartographie nationale sur la Base
                <br />
                <i class="small text-muted">
                  Comment enregistrer vos données sur la cartographie ? Comment orienter un bénéficiaire ? Les réponses à vos
                  questions sont ici.
                </i>
              </span>
            </a>
            <a
              class="btn orientation-btn bg-white mb-3 p-3 rounded-0 d-flex align-items-center"
              href="mailto:cartographie.sonum@anct.gouv.fr">
              <img src="/assets/img/logo/cartographie-nationale-brand.png" height="45" class="me-3" alt="" />
              <span class="orientation-btn-label my-auto text-start lh-sm">
                Contactez l'équipe de la Cartographie nationale des lieux d'inclusion numérique
              </span>
            </a>
          </div>
        </div>
      </app-offcanvas>
    </aside>
  </div>
</div>
