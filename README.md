# Client pour la cartographie nationale de l‚Äôoffre de m√©diation num√©rique

## √Ä propos

Ce client permet l'affichage de la [cartographie nationale de l‚Äôoffre de m√©diation num√©rique](https://d2pzn8br7bs1l.cloudfront.net/) dans un navigateur web, il est construit √† partir des √©l√©ments pr√©sents dans la biblioth√®que pour la cartographie de l‚Äôoffre de m√©diation num√©rique.

## Table des mati√®res

- ü™ß [√Ä propos](#√†-propos)
- üì¶ [Pr√©requis](#pr√©requis)
- üöÄ [Installation](#installation)
- üõ†Ô∏è [Utilisation](#utilisation)
- ü§ù [Contribution](#contribution)
- üèóÔ∏è [Construit avec](#construit-avec)
- üìö [Documentation](#documentation)
- üè∑Ô∏è [Gestion des versions](#gestion-des-versions)
- üìù [Licence](#licence)

## Pr√©requis

- [Git](https://git-scm.com/) : Syst√®me de contr√¥le de versions distribu√© d'un ensemble de fichiers
- [Node](https://nodejs.org/) : Environnement d'ex√©cution pour Javascript
- [Yarn](https://yarnpkg.com/) : Gestionnaire de paquets pour les produits d√©velopp√©s dans des environnements Node

> Node et Yarn peuvent √™tre install√©s via [nvm](https://github.com/nvm-sh/nvm) qui permet d'obtenir et d'utiliser rapidement diff√©rentes versions de Node via la ligne de commande.

## Installation

### Mise en place des sources

Ce projet a √©t√© construit dans un espace de travail Angular, pour fonctionner correctement, il est n√©cessaire de le cloner dans l'environnement pr√©vu √† cet effet :

- Suivre la proc√©dure d'installation du projet [Client Base](https://github.com/anct-cartographie-nationale/client-base)
- Puis cloner le d√©p√¥t en local dans le dossier `projects` : `git clone git@github.com:anct-cartographie-nationale/client-application.git`

### Installer Husky

[Husky](https://typicode.github.io/husky) est un outil de gestion des hooks git pour effectuer des t√¢ches automatiques

Mise en place de Husky dans le dossier du projet `projects/client-application` :

```bash
npx husky install
```

Rendre ex√©cutable les fichiers qui contiennent les hooks :

```bash
chmod a+x .husky/commit-msg
chmod a+x .husky/pre-commit
```

## Utilisation

Ces commandes servent dans un contexte de d√©veloppement de l'application et doivent √™tre ex√©cut√©es depuis la racine de l'espace de travail, c'est-√†-dire depuis le dossier parent du dossier `projects`.

### Lancement

Ex√©cuter `yarn start`, puis naviguer vers `http://localhost:4200/`.

### Construction

Ex√©cuter `yarn build client-application` pour construire le projet. Les fichiers de sortie sont √©crits dans le dossier `dist/`.

### Test

Ex√©cuter `yarn test client-application` pour tester le projet.

### ESLint

Ex√©cuter `yarn lint client-application` pour une analyse statique des fichiers `.ts` du projet.

### StyleLint

Ex√©cuter `yarn stylelint "projects/client-application/**/*.scss"` pour une analyse statique des fichiers `.scss` du projet.

### Commit lint

Ex√©cuter `yarn commitlint --from HEAD~1` pour valider la syntaxe du dernier commit.

### Prettier

Ex√©cuter `yarn prettier` pour mettre √† niveau la syntaxe de l'ensemble des fichiers du projet.

### Ajouter des ic√¥nes au projet

- Aller sur [Remixicon](https://remixicon.com/)
- Cliquer sur le dossier √† droite de la barre de recherche, puis importer la [collection du projet](./src/assets/fonts/remixicon/collection.remixicon) en cliquant sur la fl√®che vers le bas dans la modale.
- Rechercher et s√©lectionner les ic√¥nes √† ajouter
- Une fois les ajouts termin√©s
  - Cliquer sur le dossier √† droite de la barre de recherche pour t√©l√©charger le nouveau fichier de collection en cliquant sur la fl√®che vers le haut, le renommer `collection.remixicon`, puis remplacer l'ancienne version [dans le dossier des fonts](./src/assets/fonts/remixicon/)
  - Sans quitter la modale qui affiche la collection, t√©l√©charger les fonts en cliquant sur le bouton correspondant en bas √† droite, puis extraire les fichiers de l'archive pour les copier [dans le dossier des fonts](./src/assets/fonts/remixicon/) except√© les fichiers `remixicon.css` et `remixicon.less`
  - Ajouter les nouveaux `codepoint` √† la fin du fichier [icons.scss](./src/scss/components/_icons.scss) disponibles dans le fichier `remixicon.css`
  - Relancer le serveur pour appliquer les changements

## Contribution

### Nommage des branches

- Avant de cr√©er une nouvelle branche de travail, r√©cup√©rer les derni√®res modifications disponibles sur la branche `main`
- La nouvelle branche de travail doit √™te pr√©fix√©e par `build/`, `chore/`, `ci/`, `docs/`, `feat/`, `fix/`, `perf/`, `refactor/`, `revert/`, `style/` ou `test/` en fonction du type de modification pr√©vu, pour plus de d√©tails √† ce sujet, consulter [Conventional Commits cheat sheet](https://kapeli.com/cheat_sheets/Conventional_Commits.docset/Contents/Resources/Documents/index)
- Une branche portant une version √† publier doit √™tre de la forme `release/X.Y` avec `X.Y` √©gal au num√©ro de majeur et de mineur de la release, cela signifie donc que tous les patches sont √† appliquer sur la m√™me branche pour chaque version mineure. Cette organisation permet de g√©rer plusieurs versions de la biblioth√®que en parall√®le sans mettre en p√©ril la r√©trocompatibilit√©.

### Commits

#### Convention

Les commits de ce repository doivent respecter la syntaxe d√©crite par la sp√©cification des [Commits Conventionnels](https://www.conventionalcommits.org/fr)

#### Signature

La branche `main`, ainsi que l'ensemble des branches de travail avec un pr√©fixe valide requi√®rent que les commits soient sign√©s :

- La documentation de GitHub indique comment [configurer la signature des commits](https://docs.github.com/en/enterprise-server@3.5/authentication/managing-commit-signature-verification/about-commit-signature-verification)
- Les utilisateurs de [keybase](https://keybase.io/) peuvent [signer leurs commits avec leur cl√© GPG sur Keybase](https://stephenreescarter.net/signing-git-commits-with-a-keybase-gpg-key/)

### Publier sur la branche principale

- La branche principale est `main`, il n'est pas possible de publier en faisant un `push` depuis un d√©p√¥t local
- Il faut forc√©ment cr√©er une nouvelle branche de travail avec l'un pr√©fixe autoris√©
- √Ä chaque publication sur une branche de travail, le workflow `Validate feature` sur [github actions](https://github.com/anct-cartographie-nationale/client-application/actions) v√©rifie
  - Qu'il est possible de cr√©er un build sans erreur
  - Que la syntaxe correspond bien √† ce qui est [d√©fini par Prettier](https://github.com/anct-cartographie-nationale/client-base/blob/main/.prettierrc.json)
  - Que le code √©crit en TypeScript respecte les conventions d√©crites par les [r√®gles ESLint](https://github.com/anct-cartographie-nationale/client-base/blob/main/.eslintrc.json)
  - Que le style √©crit en SCSS respecte les conventions d√©crites par les [r√®gles Standard](https://github.com/anct-cartographie-nationale/client-base/blob/main/.stylelintrc.json)
  - Que les messages des commits suivent le standard √©tabli par [Conventional Commits](https://www.conventionalcommits.org/fr)
- Une fois les d√©veloppements termin√©s, il faut cr√©er une [pull request](https://github.com/anct-cartographie-nationale/client-application/pulls) avec la banche de travail comme origin et la branche `main` comme destination.
- La pull request ne peut √™tre fusionn√© que si :
  - Les √©tapes du workflow `Validate feature` sont valides
  - Les fichiers modifi√©s ont √©t√© revus par au moins une personne
  - Les commits ajout√©s sont sign√©s
- La branche de travail est supprim√©e automatiquement une fois qu'elle a √©t√© fusionn√©e

### D√©ployer

#### Sur l'environnement de production

Lorsqu'une branche est fusionn√©e avec `main`, cela d√©clenche automatiquement la publication du build sur l'espace d√©di√© √† la production ainsi que l'invalidation du cache sur le CDN.

#### Sur le registre npm

Pour publier une nouvelle version sur le registre npm, il faut que le num√©ro de version cible soit mis √† jour dans le fichier `package.json`, que le fichier `CHANGELOG.md` soit mis √† jour et que le commit de la version √† publier porte un tag de la forme `vX.Y.Z` correspondant au num√©ro de version pr√©sent dans `package.json`.

Il est possible d'automatiser ce processus en utilisant la commande `standard-version` :

- R√©cup√©rer la version √† publier depuis la branche `main`
- V√©rifier la valeur du prochain tag avec la commande `standard-version --dry-run`
- R√©cup√©rer ou cr√©er la branche `release/X.Y` correspondant √† la majeure et la mineure indiqu√©e par la commande pr√©c√©dente
- Lancer la commande `standard-version` qui
  - met √† jour la version dans le fichier `package.json`
  - met √† jour le fichier `CHANGELOG.md`
  - cr√©√© un nouveau commit
  - ajoute le tag correspondant √† la version dans le fichier `package.json`
- Pousser la branche avec le tag `git push origin release/X.Y --tags` conduit √† la publication d'une nouvelle version
- Si le num√©ro de version est le plus grand au sens de la [priorit√© d√©finie par la sp√©cification de la gestion s√©mantique de version (11)](https://semver.org/lang/fr/), alors il faut cr√©er une [pull request](https://github.com/anct-cartographie-nationale/client-application/pulls) vers la branche `main`, il ne faut pas le faire si ce n'est pas le cas.

## Construit avec

### langages & Frameworks

- [TypeScript](https://www.typescriptlang.org/) est un langage open source construit √† partir de JavaScript
- [Angular](https://angular.io/) est une bo√Æte √† outils open source pour construire des clients web
- [Remixicon](https://remixicon.com/) est un ensemble de symboles open-source √©labor√©s pour les designers et les d√©veloppeurs.

### Outils

#### CLI

- [Jest](https://jestjs.io/) est une bo√Æte √† outils pour √©crire des tests automatis√©s en JavaScript
- [Eslint](https://eslint.org/) est un analyseur statique de JavaScript
- [Stylelint](https://stylelint.io/) est un analyseur statique de fichiers de style (css, scss, etc.)
- [Prettier](https://prettier.io/) est un magnificateur de code source en JavaScript

#### CI

- [Github Actions](https://docs.github.com/en/actions) est l'outil d'int√©gration et de d√©ploiement continu int√©gr√© √† GitHub
  - L'historique des d√©ploiements est disponible [sous l'onglet Actions](https://github.com/anct-cartographie-nationale/client-application/actions/)
- Secrets du d√©p√¥t :
  - `AWS_ACCESS_KEY_ID` : Cl√© d'acc√®s AWS du compte `cartographie-nationale.client.ci`
  - `AWS_SECRET_ACCESS_KEY` : Secret associ√© √† la cl√© d'acc√®s √† AWS du compte `cartographie-nationale.client.ci`
  - `AWS_S3_BUCKET` : Identifiant de l'espace sur AWS S3 dans lequel est publi√© le build du projet pour un acc√®s public
  - `AWS_CLOUDFRONT_DISTRIBUTION_ID` : Identifiant de la distribution CloudFront qui est le CDN par lequel le site est expos√© sur internet
  - `NODE_AUTH_TOKEN` : Cl√© d'acc√®s NPM pour publier sur l'organisation [@gouvfr-anct](https://www.npmjs.com/org/gouvfr-anct)

#### D√©ploiement

##### Sur l'environnement de production

- L'infrastructure de d√©ploiement est d√©crite avec Terraform dans les d√©p√¥ts :
  - [Client Infrastructure](https://github.com/anct-cartographie-nationale/client-infrastructure)
  - [Network Infrastructure](https://github.com/anct-cartographie-nationale/network-infrastructure)
- [AWS](https://aws.amazon.com/) est la plateforme de services Cloud propos√©e par Amazon.
  - Compte de d√©ploiement : `cartographie-nationale.client.ci`
  - Groupe : `publisher.client`
  - Environnement cible : https://d2pzn8br7bs1l.cloudfront.net/

##### Sur le registre npm

- [npm](https://www.npmjs.com/) est le registre de r√©f√©rence pour les paquets Node.
  - Organisation : [@gouvfr-anct](https://www.npmjs.com/org/gouvfr-anct)
  - Paquet : [@gouvfr-anct/cartographie-nationale](https://www.npmjs.com/package/@gouvfr-anct/cartographie-nationale)

## Documentation

### Table des mati√®res

- [Int√©gration dans une page HTML](#int√©gration-dans-une-page-HTML)
- [Personnalisation](#personnalisation)

### Int√©gration dans une page HTML

La Cartographie Nationale int√®gre d√®s le d√©but de sa conception la possibilit√© d'√™tre int√©gr√©e dans n'importe quelle page HTML en 4 √©tapes.

L'√©diteur en ligne de [w3schools](https://www.w3schools.com/html/tryit.asp?filename=tryhtml_intro) permet de tester cela facilement :

1. Mise en place du chemin de r√©f√©rence

```html
...
<head>
  <title>Page Title</title>
  <base href="/" />
</head>
...
```

2. Lien vers le style `css` pour la mise en forme

```html
...
<head>
  <title>Page Title</title>
  <base href="/" />
  <link href="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/styles.css" rel="stylesheet" />
</head>
...
```

3. Liens vers les scripts `js` pour l'interactivit√©

```html
...
<body>
  <h1>My First Heading</h1>
  <p>My first paragraph.</p>

  <script src="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/script.js" type="module"></script>
</body>
...
```

4. Affichage avec l'√©l√©ment `<fr-mediation-numerique>`

```html
...
<body>
  <fr-mediation-numerique></fr-mediation-numerique>

  <script src="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/script.js" type="module"></script>
</body>
...
```

La version finale devrait ressembler √† cel√† :

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Page Title</title>
    <base href="/" />
    <link href="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/styles.css" rel="stylesheet" />
  </head>
  <body>
    <fr-mediation-numerique></fr-mediation-numerique>

    <script src="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/script.js" type="module"></script>
  </body>
</html>
```

Cliquez sur `Run >` pour voir la cartographie s'afficher.

### Personnalisation

#### Titre et logo

Exemple :

```html
<fr-mediation-numerique
  titre="Hub B"
  logo="https://getbootstrap.com/docs/5.2/assets/brand/bootstrap-logo.svg"></fr-mediation-numerique>
```

#### Source de donn√©es

Par d√©faut la source de donn√©es affiche les CnFS, pour utiliser une autre source il faut pr√©ciser une url qui fournit les donn√©es conformes au [sch√©ma de donn√©es des lieux de m√©diation num√©rique](https://lamednum.coop/schema-de-donnees-des-lieux-de-mediation-numerique)

Exemple :

```html
<fr-mediation-numerique
  source="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/assets/data/lieux-de-mediation-numerique.json"></fr-mediation-numerique>
```

#### Localisation initiale

Par d√©faut la carte est centr√©e sur le milieu de la France avec un niveau de zoom qui permet d'afficher le territoire m√©tropolitain, il est possible de pr√©ciser la latitude et la longitude sur laquelle la carte doit √™tre centr√©e ainsi que le niveau de zoom.

Exemple :

```html
<fr-mediation-numerique latitude="45.77647396140311" longitude="4.55431157343317" zoom="12"></fr-mediation-numerique>
```

- Il est possible de r√©cup√©rer la latitude et la longitude sur [openStreetMap](https://www.openstreetmap.org/node/3228260561) en recherchant une localit√©.
- Le zoom doit √™tre une valeur enti√®re comprise entre 0 et 20.

#### Couleur

Il est possible de changer certaines couleurs utilis√©es par la cartographie, pour cela il faut remplacer le style par une alternative comprenant les modifications des couleurs, notre outil disponible sur [GitHub](https://github.com/) permet de faire cela :

- [Cr√©er un compte GitHub](https://github.com/signup?ref_cta=Sign+up) si besoin
- R√©cup√©rer les sources de la cartographie [avec l'aide d'un `Fork`](https://github.com/anct-cartographie-nationale/client-application/fork) puis cliquer sur le bouton vert pour cr√©er le `Fork`
- Une fois l'op√©ration termin√©e, cliquer sur l'onglet `Actions` en haut de la page
- Autoriser l'utilisation des `Workflows`, c'est cela qui va permettre de modifier le fichier de style
- Cliquer sur `Generate custom style` dans la liste √† gauche
- Cliquer sur le bouton `Run workflow` √† droite, vous devez entrer une valeur pour `Primary Color` avant de cliquer sur le bouton `Run workflow` vert, la valeur de la couleur doit avoir cette forme : `#712cf9`, sans oublier le `#`
- Patienter quelques instants puis cliquer sur la t√¢che nomm√©e `Generate custom style` d√®s qu'elle appara√Æt
- Le fichier est g√©n√©r√© au bout de quelques minutes, lorsque c'est termin√©, un `Artifact` nomm√© `build` appara√Æt dans la liste en bas, cliquer dessus pour le t√©l√©charger puis d√©compresser l'archive `build.zip`, qui contient uniquement le fichier `style.css`
- Id√©alement il faudrait h√©berger correctement le fichier `style.css` avec le reste des fichiers du site, par exemple dans un dossier `assets/`, il faudrait alors remplacer le contenu de `<link />` vers ce chemin :
  ```html
  <head>
    <title>Page Title</title>
    <base href="/" />
    <link href="/assets/style.css" rel="stylesheet" />
  </head>
  ```
  Mais pour aller au bout de cet exemple, une autre m√©thode permet de renseigner directement le style dans la page html que nous sommes en train d'√©diter, pour cela il faut ouvrir le fichier `style.css` avec le programme `notepad` sur Windows, copier l'int√©gralit√© du contenu et le coller dans l'emplacement `<style></style>`
  ```html
  <head>
    <title>Page Title</title>
    <base href="/" />
    <style>
      Remplacer ce texte par le contenu du fichier style.css (@charset "UTF-8" etc.)
    </style>
  </head>
  ```

#### Exemple complet de personnalisation

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Page Title</title>
    <base href="/" />
    <style>
      @charset "UTF-8";:root{...
    </style>
    <link
      href="https://gist.githubusercontent.com/Kyappy/1e38c73048929c1df34d44749e3542e0/raw/5e4a06b49f3bb8431ca9cfc8f93631f4a36ba75d/styles.css"
      rel="stylesheet" />
  </head>
  <body>
    <fr-mediation-numerique
      titre="M√©diation num√©rique √† Bessenay"
      logo="https://getbootstrap.com/docs/5.2/assets/brand/bootstrap-logo.svg"
      source="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/assets/data/lieux-de-mediation-numerique.json"
      latitude="45.77647396140311"
      longitude="4.55431157343317"
      zoom="12"></fr-mediation-numerique>

    <script src="https://cdn.jsdelivr.net/npm/@gouvfr-anct/cartographie-nationale@2.2.0/script.js" type="module"></script>
  </body>
</html>
```

## Gestion des versions

Afin de maintenir un cycle de publication clair et de favoriser la r√©trocompatibilit√©, la d√©nomination des versions suit la sp√©cification d√©crite par la [Gestion s√©mantique de version](https://semver.org/lang/fr/)

Les versions disponibles ainsi que les journaux d√©crivant les changements apport√©s sont disponibles depuis [la page des Releases](https://github.com/anct-cartographie-nationale/client-application/releases).

## Licence

Voir le fichier [LICENSE.md](./LICENSE.md) du d√©p√¥t.
